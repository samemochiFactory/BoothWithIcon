{"version":3,"file":"background.js","sources":["../src/background.js"],"sourcesContent":["\r\nchrome.runtime.onMessage.addListener((message, sender, sendResponse) => {\r\n    if (message.action === 'download') {\r\n        //商品をDLするときに使われる\r\n        console.log(\"filename:\", message.filename);\r\n        console.log(\"url:\", message.url);\r\n        chrome.downloads.download({\r\n            url: message.url,\r\n            filename: message.filename,\r\n            saveAs: true\r\n        }, (downloadId) => {\r\n            if (chrome.runtime.lastError) {\r\n                console.error('Download error:', chrome.runtime.lastError);\r\n            } else {\r\n                console.log('Download started:', downloadId);\r\n            }\r\n        });\r\n    }\r\n    if (message.action === \"fetchItemInfo\") {\r\n        //商品ページ.jsonを取得するときに使われる\r\n        console.log(\"fetchItemInfo\");\r\n        console.log(message.url);\r\n        fetch(message.url)\r\n            .then(response => {\r\n                if (!response.ok) {\r\n                    throw new Error(`レスポンスステータス: ${response.status}`);\r\n                }\r\n                return response.json();\r\n            })\r\n            .then(data => {\r\n                sendResponse({ data });\r\n            })\r\n            .catch(error => {\r\n                console.error(\"フェッチエラー:\", error);\r\n                console.error(\"error url:\", message.url)\r\n                sendResponse({ error: error.message });\r\n            });\r\n\r\n        return true; // 非同期応答のためにtrueを返す\r\n    }\r\n    if (message.action === \"fetchItem\") {\r\n        //商品データを取得するときに使われる\r\n        console.log(\"fetchItem\");\r\n        console.log(message.url);\r\n        fetch(message.url)\r\n            .then(response => {\r\n                console.log(\"レスポンスステータス:\", response.status);\r\n                if (!response.ok) {\r\n                    throw new Error(`レスポンスステータス: ${response.status}`);\r\n                }\r\n                return response.arrayBuffer();\r\n            })\r\n            .then(arrayBuffer => {\r\n                // if (!arrayBuffer || arrayBuffer.byteLength === 0) {\r\n                //     throw new Error('取得した商品データが空または無効です');\r\n                // }\r\n                // sendResponse({ data: Array.from(new Uint8Array(arrayBuffer)) });\r\n                console.log(\"arrayBuffer:\", arrayBuffer);\r\n                if (!arrayBuffer) {\r\n                    throw new Error('arrayBufferがnullまたはundefinedです');\r\n                }\r\n                if (arrayBuffer.byteLength === 0) {\r\n                    throw new Error('取得した商品データが空です');\r\n                }\r\n                const byteArray = new Uint8Array(arrayBuffer);\r\n                sendResponse({ data: Array.from(byteArray) });\r\n                // sendResponse({ data: arrayBuffer }); // ←そのまま送る←これ無理．\r\n\r\n            })\r\n            .catch(error => {\r\n                console.error(\"フェッチエラー:\", error);\r\n                sendResponse({ error: error.message, data: null });\r\n            });\r\n\r\n        return true; // 非同期応答のためにtrueを返す\r\n    }\r\n    //----------------------------------------------------------------\r\n    // if (message.action === \"fetchItem\") {\r\n    //     fetch(message.url)\r\n    //         .then(response => response.arrayBuffer())\r\n    //         .then(arrayBuffer => {\r\n    //             const blob = new Blob([arrayBuffer]);\r\n    //             const blobUrl = URL.createObjectURL(blob);//これはbackgroundでは使えないらしい\r\n    //             sendResponse({ blobUrl }); // ✅ これだけ返す！\r\n    //         })\r\n    //         .catch(error => {\r\n    //             console.error(\"ファイル取得エラー:\", error);\r\n    //             sendResponse({ error: error.message });\r\n    //         });\r\n    //     return true;\r\n    // }\r\n    //------------------------------------------------------------------\r\n    if (message.action === \"fetchThumbnail\") {\r\n        //サムネイル画像を取得するときに使われる\r\n        console.log(\"fetchThumbnail\");\r\n        console.log(message.url);\r\n        fetch(message.url)\r\n            .then(response => {\r\n                if (!response.ok) {\r\n                    throw new Error(`レスポンスステータス: ${response.status}`);\r\n                }\r\n                return response.arrayBuffer();\r\n            })\r\n            .then(arrayBuffer => {\r\n                sendResponse({ data: Array.from(new Uint8Array(arrayBuffer)) });\r\n            })\r\n            .catch(error => {\r\n                console.error(\"フェッチエラー:\", error);\r\n                sendResponse({ error: error.message, data: null });\r\n            });\r\n        return true; // 非同期応答のためにtrueを返す\r\n    }\r\n    if (message.action === 'downloadZip') {\r\n        chrome.downloads.download({\r\n            url: message.blobUrl,\r\n            filename: message.filename,\r\n            saveAs: true\r\n        }, downloadId => {\r\n            if (chrome.runtime.lastError) {\r\n                console.error('Download failed:', chrome.runtime.lastError);\r\n            } else {\r\n                console.log('Download started:', downloadId);\r\n            }\r\n        });\r\n    }\r\n});"],"names":["message","sender","sendResponse","downloadId","response","data","error","arrayBuffer","byteArray"],"mappings":"AACA,OAAO,QAAQ,UAAU,YAAY,CAACA,EAASC,EAAQC,IAAiB,CAiBpE,GAhBIF,EAAQ,SAAW,aAEnB,QAAQ,IAAI,YAAaA,EAAQ,QAAQ,EACzC,QAAQ,IAAI,OAAQA,EAAQ,GAAG,EAC/B,OAAO,UAAU,SAAS,CACtB,IAAKA,EAAQ,IACb,SAAUA,EAAQ,SAClB,OAAQ,EACX,EAAGG,GAAe,CACX,OAAO,QAAQ,UACf,QAAQ,MAAM,kBAAmB,OAAO,QAAQ,SAAS,EAEzD,QAAQ,IAAI,oBAAqBA,CAAU,CAE3D,CAAS,GAEDH,EAAQ,SAAW,gBAEnB,eAAQ,IAAI,eAAe,EAC3B,QAAQ,IAAIA,EAAQ,GAAG,EACvB,MAAMA,EAAQ,GAAG,EACZ,KAAKI,GAAY,CACd,GAAI,CAACA,EAAS,GACV,MAAM,IAAI,MAAM,eAAeA,EAAS,MAAM,EAAE,EAEpD,OAAOA,EAAS,MAChC,CAAa,EACA,KAAKC,GAAQ,CACVH,EAAa,CAAE,KAAAG,CAAI,CAAE,CACrC,CAAa,EACA,MAAMC,GAAS,CACZ,QAAQ,MAAM,WAAYA,CAAK,EAC/B,QAAQ,MAAM,aAAcN,EAAQ,GAAG,EACvCE,EAAa,CAAE,MAAOI,EAAM,OAAS,CAAA,CACrD,CAAa,EAEE,GAEX,GAAIN,EAAQ,SAAW,YAEnB,eAAQ,IAAI,WAAW,EACvB,QAAQ,IAAIA,EAAQ,GAAG,EACvB,MAAMA,EAAQ,GAAG,EACZ,KAAKI,GAAY,CAEd,GADA,QAAQ,IAAI,cAAeA,EAAS,MAAM,EACtC,CAACA,EAAS,GACV,MAAM,IAAI,MAAM,eAAeA,EAAS,MAAM,EAAE,EAEpD,OAAOA,EAAS,aAChC,CAAa,EACA,KAAKG,GAAe,CAMjB,GADA,QAAQ,IAAI,eAAgBA,CAAW,EACnC,CAACA,EACD,MAAM,IAAI,MAAM,gCAAgC,EAEpD,GAAIA,EAAY,aAAe,EAC3B,MAAM,IAAI,MAAM,eAAe,EAEnC,MAAMC,EAAY,IAAI,WAAWD,CAAW,EAC5CL,EAAa,CAAE,KAAM,MAAM,KAAKM,CAAS,CAAC,CAAE,CAG5D,CAAa,EACA,MAAMF,GAAS,CACZ,QAAQ,MAAM,WAAYA,CAAK,EAC/BJ,EAAa,CAAE,MAAOI,EAAM,QAAS,KAAM,IAAI,CAAE,CACjE,CAAa,EAEE,GAkBX,GAAIN,EAAQ,SAAW,iBAEnB,eAAQ,IAAI,gBAAgB,EAC5B,QAAQ,IAAIA,EAAQ,GAAG,EACvB,MAAMA,EAAQ,GAAG,EACZ,KAAKI,GAAY,CACd,GAAI,CAACA,EAAS,GACV,MAAM,IAAI,MAAM,eAAeA,EAAS,MAAM,EAAE,EAEpD,OAAOA,EAAS,aAChC,CAAa,EACA,KAAKG,GAAe,CACjBL,EAAa,CAAE,KAAM,MAAM,KAAK,IAAI,WAAWK,CAAW,CAAC,CAAC,CAAE,CAC9E,CAAa,EACA,MAAMD,GAAS,CACZ,QAAQ,MAAM,WAAYA,CAAK,EAC/BJ,EAAa,CAAE,MAAOI,EAAM,QAAS,KAAM,IAAI,CAAE,CACjE,CAAa,EACE,GAEPN,EAAQ,SAAW,eACnB,OAAO,UAAU,SAAS,CACtB,IAAKA,EAAQ,QACb,SAAUA,EAAQ,SAClB,OAAQ,EACX,EAAEG,GAAc,CACT,OAAO,QAAQ,UACf,QAAQ,MAAM,mBAAoB,OAAO,QAAQ,SAAS,EAE1D,QAAQ,IAAI,oBAAqBA,CAAU,CAE3D,CAAS,CAET,CAAC"}