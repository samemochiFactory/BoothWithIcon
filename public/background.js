chrome.runtime.onMessage.addListener((r,c,n)=>{if(r.action==="download"&&(console.log("filename:",r.filename),console.log("url:",r.url),chrome.downloads.download({url:r.url,filename:r.filename,saveAs:!0},o=>{chrome.runtime.lastError?console.error("Download error:",chrome.runtime.lastError):console.log("Download started:",o)})),r.action==="fetchItemInfo")return console.log("fetchItemInfo"),console.log(r.url),fetch(r.url).then(o=>{if(!o.ok)throw new Error(`レスポンスステータス: ${o.status}`);return o.json()}).then(o=>{n({data:o})}).catch(o=>{console.error("フェッチエラー:",o),console.error("error url:",r.url),n({error:o.message})}),!0;if(r.action==="fetchItem")return fetch(r.url).then(t=>t.blob()).then(async t=>{const e=Math.ceil(t.size/10485760);n({status:"start",totalChunks:e,totalSize:t.size,type:t.type});for(let l=0;l<e;l++){const i=l*10485760,u=Math.min(i+10485760,t.size),d=t.slice(i,u),a=new FileReader;await new Promise(h=>{a.onloadend=()=>{chrome.tabs.sendMessage(c.tab.id,{action:"receiveChunk",chunkIndex:l,totalChunks:e,dataUrl:a.result}),h()},a.readAsDataURL(d)})}}).catch(t=>{console.error("チャンク送信エラー:",t),chrome.tabs.sendMessage(c.tab.id,{action:"downloadError",downloadId:r.downloadId,error:t.toString()})}),!0;if(r.action==="fetchThumbnail")return console.log("fetchThumbnail"),console.log(r.url),fetch(r.url).then(o=>{if(!o.ok)throw new Error(`レスポンスステータス: ${o.status}`);return o.arrayBuffer()}).then(o=>{n({data:Array.from(new Uint8Array(o))})}).catch(o=>{console.error("フェッチエラー:",o),n({error:o.message,data:null})}),!0;r.action==="downloadZip"&&chrome.downloads.download({url:r.blobUrl,filename:r.filename,saveAs:!0},o=>{chrome.runtime.lastError?console.error("Download failed:",chrome.runtime.lastError):console.log("Download started:",o)})});
//# sourceMappingURL=background.js.map
