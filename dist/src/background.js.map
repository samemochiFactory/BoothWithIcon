{"version":3,"file":"background.js","sources":["../../src/background.js"],"sourcesContent":["\r\nchrome.runtime.onMessage.addListener((msg, sender, sendResponse) => {\r\n    //TODO:fetch系の関数は共通化して，responseの処理方法をフロント側で変えるとかする．\r\n    if (msg.action === \"fetchItemInfo\") {\r\n        //商品ページ.jsonを取得するときに使われる\r\n        console.log(\"fetchItemInfo\");\r\n        console.log(msg.url);\r\n        fetch(msg.url)\r\n            .then(response => {\r\n                if (!response.ok) {\r\n                    throw new Error(`response status : ${response.status}`);\r\n                }\r\n                return response.json();\r\n            })\r\n            .then(data => {\r\n                sendResponse({ data });\r\n            })\r\n            .catch(error => {\r\n                console.error(\"fetch error:\", error);\r\n                console.error(\"error url:\", msg.url)\r\n                sendResponse({ error: error.message });\r\n            });\r\n\r\n        return true; // 非同期応答のためにtrueを返す\r\n    }\r\n    //チャンク送信\r\n    if (msg.action === \"fetchItem\") {\r\n        const CHUNK_SIZE = 10 * 1024 * 1024; // 10MB チャンクサイズ\r\n\r\n        fetch(msg.url)\r\n            .then(response => response.blob())\r\n            .then(async blob => {//クソデカblob\r\n                // console.log(\"send blobtype : \", blob.type);\r\n                const totalChunks = Math.ceil(blob.size / CHUNK_SIZE);\r\n\r\n                // 最初のレスポンスでメタデータを送信\r\n                sendResponse({\r\n                    status: \"start\",\r\n                    totalChunks: totalChunks,\r\n                    totalSize: blob.size,\r\n                    type: blob.type\r\n                });\r\n                // console.log(\"sending progress to id : \", msg.progressBarId);\r\n                // チャンクごとに処理\r\n                for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {\r\n                    const start = chunkIndex * CHUNK_SIZE;\r\n                    const end = Math.min(start + CHUNK_SIZE, blob.size);\r\n                    const chunkBlob = blob.slice(start, end);\r\n\r\n                    // チャンクをBase64に変換\r\n                    const reader = new FileReader();\r\n\r\n                    // Promiseでラップして同期的に処理\r\n                    await new Promise(resolve => {\r\n                        reader.onloadend = () => {\r\n                            // チャンクデータをcontent.jsに送信\r\n                            chrome.tabs.sendMessage(sender.tab.id, {\r\n                                action: \"receiveChunk\",\r\n                                chunkIndex: chunkIndex,\r\n                                totalChunks: totalChunks,\r\n                                dataUrl: reader.result,\r\n                                progressBarId: msg.progressBarId\r\n                            });\r\n                            resolve();\r\n                        };\r\n                        reader.readAsDataURL(chunkBlob);\r\n                    });\r\n                }\r\n            })\r\n            .catch(error => {\r\n                console.error(\"chunk sending error:\", error);\r\n                chrome.tabs.sendMessage(sender.tab.id, {\r\n                    action: \"downloadError\",\r\n                    downloadId: msg.downloadId,\r\n                    error: error.toString()\r\n                });\r\n            });\r\n\r\n        // 非同期処理を行うため、sendResponseを後で呼び出すことを示す\r\n        return true;\r\n    }\r\n    if (msg.action === \"fetchThumbnail\") {\r\n        //サムネイル画像を取得するときに使われる\r\n        console.log(\"fetchThumbnail\");\r\n        console.log(msg.url);\r\n        fetch(msg.url)\r\n            .then(response => {\r\n                if (!response.ok) {\r\n                    throw new Error(`response status: ${response.status}`);\r\n                }\r\n                return response.arrayBuffer();\r\n            })\r\n            .then(arrayBuffer => {\r\n                sendResponse({ data: Array.from(new Uint8Array(arrayBuffer)) });\r\n            })\r\n            .catch(error => {\r\n                console.error(\"fetch error\", error);\r\n                sendResponse({ error: error.message, data: null });\r\n            });\r\n        return true; // 非同期応答のためにtrueを返す\r\n    }\r\n    if (msg.action === 'downloadZip') {\r\n        chrome.downloads.download({\r\n            url: msg.blobUrl,\r\n            filename: msg.filename,\r\n            saveAs: true\r\n        }, downloadId => {\r\n            if (chrome.runtime.lastError) {\r\n                console.error('Download failed:', chrome.runtime.lastError);\r\n            } else {\r\n                console.log('Download started:', downloadId);\r\n            }\r\n        });\r\n    }\r\n});"],"names":["chrome","runtime","onMessage","addListener","msg","sender","sendResponse","action","console","log","url","fetch","then","response","ok","Error","status","json","data","catch","error","message","CHUNK_SIZE","blob","async","totalChunks","Math","ceil","size","totalSize","type","chunkIndex","start","end","min","chunkBlob","slice","reader","FileReader","Promise","resolve","onloadend","tabs","sendMessage","tab","id","dataUrl","result","progressBarId","readAsDataURL","downloadId","toString","arrayBuffer","Array","from","Uint8Array","downloads","download","blobUrl","filename","saveAs","lastError"],"mappings":"AACAA,OAAOC,QAAQC,UAAUC,aAAY,CAACC,EAAKC,EAAQC,KAE3C,GAAe,kBAAfF,EAAIG,OAoBG,OAlBPC,QAAQC,IAAI,iBACJD,QAAAC,IAAIL,EAAIM,KAChBC,MAAMP,EAAIM,KACLE,MAAiBC,IACV,IAACA,EAASC,GACV,MAAM,IAAIC,MAAM,qBAAqBF,EAASG,UAElD,OAAOH,EAASI,UAEnBL,MAAaM,IACGZ,EAAA,CAAEY,YAElBC,OAAeC,IACJZ,QAAAY,MAAM,eAAgBA,GACtBZ,QAAAY,MAAM,aAAchB,EAAIM,KAChCJ,EAAa,CAAEc,MAAOA,EAAMC,cAG7B,EAGP,GAAe,cAAfjB,EAAIG,OAAwB,CACtB,MAAAe,EAAa,SAoDZ,OAlDDX,MAAAP,EAAIM,KACLE,MAAKC,GAAYA,EAASU,SAC1BX,MAAKY,MAAMD,IAER,MAAME,EAAcC,KAAKC,KAAKJ,EAAKK,KAAON,GAG7BhB,EAAA,CACTU,OAAQ,QACRS,cACAI,UAAWN,EAAKK,KAChBE,KAAMP,EAAKO,OAIf,IAAA,IAASC,EAAa,EAAGA,EAAaN,EAAaM,IAAc,CAC7D,MAAMC,EAAQD,EAAaT,EACrBW,EAAMP,KAAKQ,IAAIF,EAAQV,EAAYC,EAAKK,MACxCO,EAAYZ,EAAKa,MAAMJ,EAAOC,GAG9BI,EAAS,IAAIC,iBAGb,IAAIC,SAAmBC,IACzBH,EAAOI,UAAY,KAEfzC,OAAO0C,KAAKC,YAAYtC,EAAOuC,IAAIC,GAAI,CACnCtC,OAAQ,eACRwB,aACAN,cACAqB,QAAST,EAAOU,OAChBC,cAAe5C,EAAI4C,qBAI3BX,EAAOY,cAAcd,KAE5B,KAEJhB,OAAeC,IACJZ,QAAAY,MAAM,uBAAwBA,GACtCpB,OAAO0C,KAAKC,YAAYtC,EAAOuC,IAAIC,GAAI,CACnCtC,OAAQ,gBACR2C,WAAY9C,EAAI8C,WAChB9B,MAAOA,EAAM+B,iBAKlB,CACV,CACG,GAAe,mBAAf/C,EAAIG,OAkBG,OAhBPC,QAAQC,IAAI,kBACJD,QAAAC,IAAIL,EAAIM,KAChBC,MAAMP,EAAIM,KACLE,MAAiBC,IACV,IAACA,EAASC,GACV,MAAM,IAAIC,MAAM,oBAAoBF,EAASG,UAEjD,OAAOH,EAASuC,iBAEnBxC,MAAoBwC,IACJ9C,EAAA,CAAEY,KAAMmC,MAAMC,KAAK,IAAIC,WAAWH,SAElDjC,OAAeC,IACJZ,QAAAY,MAAM,cAAeA,GAC7Bd,EAAa,CAAEc,MAAOA,EAAMC,QAASH,KAAM,WAE5C,EAEQ,gBAAfd,EAAIG,QACJP,OAAOwD,UAAUC,SAAS,CACtB/C,IAAKN,EAAIsD,QACTC,SAAUvD,EAAIuD,SACdC,QAAQ,IACKV,IACTlD,OAAOC,QAAQ4D,UACfrD,QAAQY,MAAM,mBAAoBpB,OAAOC,QAAQ4D,WAEzCrD,QAAAC,IAAI,oBAAqByC"}